<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admission Board</title>
    <style>
        :root { --primary: #00695c; --accent: #e0f2f1; --text: #37474f; --border: #cfd8dc; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7f8; margin: 0; padding-bottom: 100px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        /* Header with Status */
        .header { background: white; padding: 12px 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; font-size: 1.1rem; color: var(--primary); }
        .status-indicator { font-size: 0.75rem; color: #28a745; display: flex; align-items: center; gap: 4px; font-weight: bold; opacity: 0; transition: opacity 0.3s; }
        .btn-clear { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; cursor: pointer; }

        /* Accordion Sections */
        details { background: white; margin: 10px 10px; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        details[open] { border-color: var(--primary); }
        summary { padding: 15px; font-weight: bold; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        summary::-webkit-details-marker { display: none; }
        summary:after { content: '+'; font-size: 1.2rem; color: #777; }
        details[open] summary { background: var(--accent); color: var(--primary); border-bottom: 1px solid var(--primary); }
        details[open] summary:after { content: '-'; }
        
        .section-content { padding: 15px; }

        /* --- UI Components Reuse --- */
        /* Muscle/MAS Buttons */
        .label-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; color: #666; font-weight: 600; }
        .btn-group { display: flex; width: 100%; border: 1px solid var(--primary); border-radius: 6px; overflow: hidden; margin-bottom: 15px; }
        .seg-btn { flex: 1; padding: 10px 0; background: white; border: none; border-right: 1px solid var(--primary); color: var(--primary); font-weight: bold; cursor: pointer; font-size: 14px; }
        .seg-btn:last-child { border-right: none; }
        .seg-btn.active { background: var(--primary); color: white; }

        /* Barthel Radio */
        .barthel-item { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .b-title { font-weight: 600; margin-bottom: 8px; font-size: 0.95rem; }
        .b-opts { display: flex; gap: 8px; }
        .b-lbl { flex: 1; background: #f1f3f4; text-align: center; padding: 8px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .b-radio { display: none; }
        .b-radio:checked + .b-lbl { background: var(--primary); color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* FAB Actions */
        .fab-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; z-index: 200; }
        .btn-main { flex: 1; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div class="header">
    <button class="btn-clear" onclick="clearAll()">Reset New Patient</button>
    <h1>Admission Board</h1>
    <div class="status-indicator" id="saveStatus">âœ“ Saved</div>
</div>

<details open>
    <summary>Muscle Power (MMT)</summary>
    <div class="section-content">
        <div class="label-row"><span>Upper Proximal (Sh/Elb)</span></div>
        <div class="btn-group" data-key="mmt_ue_prox">
            <button class="seg-btn" onclick="setVal(this)">0</button>
            <button class="seg-btn" onclick="setVal(this)">1</button>
            <button class="seg-btn" onclick="setVal(this)">2</button>
            <button class="seg-btn" onclick="setVal(this)">3</button>
            <button class="seg-btn" onclick="setVal(this)">4</button>
            <button class="seg-btn active" onclick="setVal(this)">5</button>
        </div>
        <div class="label-row"><span>Upper Distal (Hand)</span></div>
        <div class="btn-group" data-key="mmt_ue_dist">
            <button class="seg-btn" onclick="setVal(this)">0</button>
            <button class="seg-btn" onclick="setVal(this)">1</button>
            <button class="seg-btn" onclick="setVal(this)">2</button>
            <button class="seg-btn" onclick="setVal(this)">3</button>
            <button class="seg-btn" onclick="setVal(this)">4</button>
            <button class="seg-btn active" onclick="setVal(this)">5</button>
        </div>
        <div class="label-row"><span>Lower Proximal (Hip/Knee)</span></div>
        <div class="btn-group" data-key="mmt_le_prox">
            <button class="seg-btn" onclick="setVal(this)">0</button>
            <button class="seg-btn" onclick="setVal(this)">1</button>
            <button class="seg-btn" onclick="setVal(this)">2</button>
            <button class="seg-btn" onclick="setVal(this)">3</button>
            <button class="seg-btn" onclick="setVal(this)">4</button>
            <button class="seg-btn active" onclick="setVal(this)">5</button>
        </div>
        <div class="label-row"><span>Lower Distal (Ankle)</span></div>
        <div class="btn-group" data-key="mmt_le_dist">
            <button class="seg-btn" onclick="setVal(this)">0</button>
            <button class="seg-btn" onclick="setVal(this)">1</button>
            <button class="seg-btn" onclick="setVal(this)">2</button>
            <button class="seg-btn" onclick="setVal(this)">3</button>
            <button class="seg-btn" onclick="setVal(this)">4</button>
            <button class="seg-btn active" onclick="setVal(this)">5</button>
        </div>
    </div>
</details>

<details>
    <summary>Tone (MAS) - Affected Side</summary>
    <div class="section-content">
        <div class="label-row"><span>Elbow Flexor</span></div>
        <div class="btn-group" data-key="mas_elb">
            <button class="seg-btn active" onclick="setVal(this)">0</button>
            <button class="seg-btn" onclick="setVal(this)">1</button>
            <button class="seg-btn" onclick="setVal(this)">1+</button>
            <button class="seg-btn" onclick="setVal(this)">2</button>
            <button class="seg-btn" onclick="setVal(this)">3</button>
        </div>
        <div class="label-row"><span>Wrist Flexor</span></div>
        <div class="btn-group" data-key="mas_wri">
            <button class="seg-btn active" onclick="setVal(this)">0</button>
            <button class="seg-btn" onclick="setVal(this)">1</button>
            <button class="seg-btn" onclick="setVal(this)">1+</button>
            <button class="seg-btn" onclick="setVal(this)">2</button>
            <button class="seg-btn" onclick="setVal(this)">3</button>
        </div>
        <div class="label-row"><span>Ankle Plantar Flexor</span></div>
        <div class="btn-group" data-key="mas_ank">
            <button class="seg-btn active" onclick="setVal(this)">0</button>
            <button class="seg-btn" onclick="setVal(this)">1</button>
            <button class="seg-btn" onclick="setVal(this)">1+</button>
            <button class="seg-btn" onclick="setVal(this)">2</button>
            <button class="seg-btn" onclick="setVal(this)">3</button>
        </div>
    </div>
</details>

<details>
    <summary>Barthel Index <span id="bi-score" style="font-weight:normal; margin-left:10px; color:var(--primary)">(100)</span></summary>
    <div class="section-content" id="barthel-container">
        </div>
</details>

<details>
    <summary>Quick Notes</summary>
    <div class="section-content">
        <textarea id="free-text" placeholder="Any specific observation..." style="width:100%; height:60px; border:1px solid #ccc; border-radius:4px; padding:8px;" oninput="saveData()"></textarea>
    </div>
</details>

<div style="height: 80px;"></div> <div class="fab-container">
    <button class="btn-main" onclick="copyAll()">ðŸ“‹ Copy Full Note</button>
</div>

<script>
    // --- 1. Data & State Management ---
    
    // Load saved data on boot
    window.onload = function() {
        renderBarthel();
        loadData();
    };

    function saveData() {
        // Collect all data
        const data = {
            mmt: collectBtnGroup('mmt'),
            mas: collectBtnGroup('mas'),
            barthel: collectRadio('bi'),
            note: document.getElementById('free-text').value
        };
        localStorage.setItem('rehab_admission_data', JSON.stringify(data));
        
        // Show save indicator
        const ind = document.getElementById('saveStatus');
        ind.style.opacity = 1;
        setTimeout(() => ind.style.opacity = 0, 1500);
        
        // Update BI Score display
        calcBarthelScore();
    }

    function loadData() {
        const raw = localStorage.getItem('rehab_admission_data');
        if (!raw) return;
        const data = JSON.parse(raw);

        // Restore Buttons (MMT/MAS)
        for (let key in data.mmt) restoreBtnGroup(key, data.mmt[key]);
        for (let key in data.mas) restoreBtnGroup(key, data.mas[key]);
        
        // Restore Barthel
        for (let key in data.barthel) {
            const radio = document.querySelector(`input[name="${key}"][value="${data.barthel[key]}"]`);
            if(radio) radio.checked = true;
        }

        // Restore Note
        if(data.note) document.getElementById('free-text').value = data.note;

        calcBarthelScore();
    }

    function clearAll() {
        if(confirm("Start new patient? This will clear current data.")) {
            localStorage.removeItem('rehab_admission_data');
            location.reload();
        }
    }

    // --- 2. UI Logic Helpers ---

    // For Button Groups (MMT/MAS)
    window.setVal = function(btn) {
        const group = btn.parentElement;
        group.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        saveData();
    }

    function collectBtnGroup(prefix) {
        const result = {};
        document.querySelectorAll(`.btn-group[data-key^="${prefix}"]`).forEach(group => {
            const active = group.querySelector('.active');
            if(active) result[group.dataset.key] = active.innerText;
        });
        return result;
    }

    function restoreBtnGroup(key, val) {
        const group = document.querySelector(`.btn-group[data-key="${key}"]`);
        if(!group) return;
        group.querySelectorAll('.seg-btn').forEach(b => {
            if(b.innerText === val) {
                group.querySelectorAll('.seg-btn').forEach(x=>x.classList.remove('active'));
                b.classList.add('active');
            }
        });
    }

    // For Radios (Barthel)
    function collectRadio(prefix) {
        const result = {};
        document.querySelectorAll(`input[name^="${prefix}"]`).forEach(r => {
            if(r.checked) result[r.name] = r.value;
        });
        return result;
    }

    // --- 3. Barthel Logic ---
    const biItems = [
        {k:'bi_feed', t:'Feeding', o:[10,5,0]}, {k:'bi_bath', t:'Bathing', o:[5,0]},
        {k:'bi_groom', t:'Grooming', o:[5,0]}, {k:'bi_dress', t:'Dressing', o:[10,5,0]},
        {k:'bi_bowel', t:'Bowels', o:[10,5,0]}, {k:'bi_blad', t:'Bladder', o:[10,5,0]},
        {k:'bi_toil', t:'Toilet', o:[10,5,0]}, {k:'bi_trans', t:'Transfer', o:[15,10,5,0]},
        {k:'bi_mob', t:'Mobility', o:[15,10,5,0]}, {k:'bi_stair', t:'Stairs', o:[10,5,0]}
    ];

    function renderBarthel() {
        const c = document.getElementById('barthel-container');
        let html = '';
        biItems.forEach(i => {
            html += `<div class="barthel-item"><div class="b-title">${i.t}</div><div class="b-opts">`;
            i.o.forEach((val, idx) => {
                // Default check the first option (Max score) for speed? Or keep null?
                // Let's Default to MAX to save clicks for healthy patients, but user requested state saving.
                // Let's leave unchecked by default unless loaded.
                html += `
                    <input type="radio" name="${i.k}" value="${val}" id="${i.k}_${val}" class="b-radio" onchange="saveData()">
                    <label class="b-lbl" for="${i.k}_${val}">${val}</label>
                `;
            });
            html += `</div></div>`;
        });
        c.innerHTML = html;
    }

    function calcBarthelScore() {
        let sum = 0;
        biItems.forEach(i => {
            const sel = document.querySelector(`input[name="${i.k}"]:checked`);
            if(sel) sum += parseInt(sel.value);
        });
        document.getElementById('bi-score').innerText = `(${sum})`;
        return sum;
    }

    // --- 4. Export Logic ---
    function copyAll() {
        const d = JSON.parse(localStorage.getItem('rehab_admission_data') || "{}");
        const mmt = d.mmt || {};
        const mas = d.mas || {};
        const bi = d.barthel || {};
        
        let text = `=== Physical Exam & Assessment ===\n`;
        
        // MMT
        text += `\n[Muscle Power (MMT)]\n`;
        text += `UE (Prox/Dist): ${mmt.mmt_ue_prox||'?'}/${mmt.mmt_ue_dist||'?'} | `;
        text += `LE (Prox/Dist): ${mmt.mmt_le_prox||'?'}/${mmt.mmt_le_dist||'?'}\n`;

        // MAS (Only if abnormal, i.e., not 0, or just show all)
        // Let's show concise line
        text += `\n[Muscle Tone (MAS)]\n`;
        text += `Elbow: ${mas.mas_elb||'0'}, Wrist: ${mas.mas_wri||'0'}, Ankle: ${mas.mas_ank||'0'}\n`;

        // Barthel
        const biScore = document.getElementById('bi-score').innerText;
        text += `\n[Barthel Index]: Total ${biScore}\n`;
        // Create a mini string of details: "Feed:10, Bath:5..."
        let biDets = [];
        biItems.forEach(i => {
            if(bi[i.k] !== undefined) biDets.push(`${i.t.substring(0,3)}:${bi[i.k]}`);
        });
        text += biDets.join(', ') + '\n';

        // Note
        if(d.note) text += `\n[Note]: ${d.note}\n`;

        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('.btn-main');
            const old = btn.innerHTML;
            btn.innerHTML = "âœ… Copied to Clipboard!";
            btn.style.background = "#28a745";
            setTimeout(() => {
                btn.innerHTML = old;
                btn.style.background = "#00695c";
            }, 2000);
        });
    }
</script>

</body>
</html>
